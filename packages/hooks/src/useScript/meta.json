{
  "$schema": "https://raw.githubusercontent.com/sseuniverse/sse-hooks/refs/heads/main/schema/meta.json",
  "name": "use-script",
  "type": "registry:hook",
  "title": "useScript",
  "description": "Script loading status.",
  "dependencies": [
    "react"
  ],
  "registryDependencies": [],
  "file": {
    "content": "import { useEffect, useState } from \"react\";\r\n\r\n\r\ntype UseScriptStatus = \"idle\" | \"loading\" | \"ready\" | \"error\";\r\n\r\n\r\ntype UseScriptOptions = {\r\n  \r\n  shouldPreventLoad?: boolean;\r\n  \r\n  removeOnUnmount?: boolean;\r\n  \r\n  id?: string;\r\n};\r\n\r\n\r\nconst cachedScriptStatuses = new Map<string, UseScriptStatus | undefined>();\r\n\r\n\r\nfunction getScriptNode(src: string) {\r\n  const node: HTMLScriptElement | null = document.querySelector(\r\n    `script[src=\"${src}\"]`,\r\n  );\r\n  const status = node?.getAttribute(\"data-status\") as\r\n    | UseScriptStatus\r\n    | undefined;\r\n\r\n  return {\r\n    node,\r\n    status,\r\n  };\r\n}\r\n\r\n\r\nexport function useScript(\r\n  src: string | null,\r\n  options?: UseScriptOptions,\r\n): UseScriptStatus {\r\n  const [status, setStatus] = useState<UseScriptStatus>(() => {\r\n    if (!src || options?.shouldPreventLoad) {\r\n      return \"idle\";\r\n    }\r\n\r\n    if (typeof window === \"undefined\") {\r\n      \r\n      return \"loading\";\r\n    }\r\n\r\n    return cachedScriptStatuses.get(src) ?? \"loading\";\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (!src || options?.shouldPreventLoad) {\r\n      return;\r\n    }\r\n\r\n    const cachedScriptStatus = cachedScriptStatuses.get(src);\r\n    if (cachedScriptStatus === \"ready\" || cachedScriptStatus === \"error\") {\r\n      \r\n      setStatus(cachedScriptStatus);\r\n      return;\r\n    }\r\n\r\n    \r\n    \r\n    const script = getScriptNode(src);\r\n    let scriptNode = script.node;\r\n\r\n    if (!scriptNode) {\r\n      \r\n      scriptNode = document.createElement(\"script\");\r\n      scriptNode.src = src;\r\n      scriptNode.async = true;\r\n      if (options?.id) {\r\n        scriptNode.id = options.id;\r\n      }\r\n      scriptNode.setAttribute(\"data-status\", \"loading\");\r\n      document.body.appendChild(scriptNode);\r\n\r\n      \r\n      \r\n      const setAttributeFromEvent = (event: Event) => {\r\n        const scriptStatus: UseScriptStatus =\r\n          event.type === \"load\" ? \"ready\" : \"error\";\r\n\r\n        scriptNode?.setAttribute(\"data-status\", scriptStatus);\r\n      };\r\n\r\n      scriptNode.addEventListener(\"load\", setAttributeFromEvent);\r\n      scriptNode.addEventListener(\"error\", setAttributeFromEvent);\r\n    } else {\r\n      \r\n      setStatus(script.status ?? cachedScriptStatus ?? \"loading\");\r\n    }\r\n\r\n    \r\n    \r\n    \r\n    const setStateFromEvent = (event: Event) => {\r\n      const newStatus = event.type === \"load\" ? \"ready\" : \"error\";\r\n      setStatus(newStatus);\r\n      cachedScriptStatuses.set(src, newStatus);\r\n    };\r\n\r\n    \r\n    scriptNode.addEventListener(\"load\", setStateFromEvent);\r\n    scriptNode.addEventListener(\"error\", setStateFromEvent);\r\n\r\n    \r\n    return () => {\r\n      if (scriptNode) {\r\n        scriptNode.removeEventListener(\"load\", setStateFromEvent);\r\n        scriptNode.removeEventListener(\"error\", setStateFromEvent);\r\n      }\r\n\r\n      if (scriptNode && options?.removeOnUnmount) {\r\n        scriptNode.remove();\r\n        cachedScriptStatuses.delete(src);\r\n      }\r\n    };\r\n  }, [src, options?.shouldPreventLoad, options?.removeOnUnmount, options?.id]);\r\n\r\n  return status;\r\n}",
    "js": "import { useEffect, useState } from \"react\";\nconst cachedScriptStatuses = new Map();\nfunction getScriptNode(src) {\n    const node = document.querySelector(`script[src=\"${src}\"]`);\n    const status = node?.getAttribute(\"data-status\");\n    return {\n        node,\n        status,\n    };\n}\nexport function useScript(src, options) {\n    const [status, setStatus] = useState(() => {\n        if (!src || options?.shouldPreventLoad) {\n            return \"idle\";\n        }\n        if (typeof window === \"undefined\") {\n            return \"loading\";\n        }\n        return cachedScriptStatuses.get(src) ?? \"loading\";\n    });\n    useEffect(() => {\n        if (!src || options?.shouldPreventLoad) {\n            return;\n        }\n        const cachedScriptStatus = cachedScriptStatuses.get(src);\n        if (cachedScriptStatus === \"ready\" || cachedScriptStatus === \"error\") {\n            setStatus(cachedScriptStatus);\n            return;\n        }\n        const script = getScriptNode(src);\n        let scriptNode = script.node;\n        if (!scriptNode) {\n            scriptNode = document.createElement(\"script\");\n            scriptNode.src = src;\n            scriptNode.async = true;\n            if (options?.id) {\n                scriptNode.id = options.id;\n            }\n            scriptNode.setAttribute(\"data-status\", \"loading\");\n            document.body.appendChild(scriptNode);\n            const setAttributeFromEvent = (event) => {\n                const scriptStatus = event.type === \"load\" ? \"ready\" : \"error\";\n                scriptNode?.setAttribute(\"data-status\", scriptStatus);\n            };\n            scriptNode.addEventListener(\"load\", setAttributeFromEvent);\n            scriptNode.addEventListener(\"error\", setAttributeFromEvent);\n        }\n        else {\n            setStatus(script.status ?? cachedScriptStatus ?? \"loading\");\n        }\n        const setStateFromEvent = (event) => {\n            const newStatus = event.type === \"load\" ? \"ready\" : \"error\";\n            setStatus(newStatus);\n            cachedScriptStatuses.set(src, newStatus);\n        };\n        scriptNode.addEventListener(\"load\", setStateFromEvent);\n        scriptNode.addEventListener(\"error\", setStateFromEvent);\n        return () => {\n            if (scriptNode) {\n                scriptNode.removeEventListener(\"load\", setStateFromEvent);\n                scriptNode.removeEventListener(\"error\", setStateFromEvent);\n            }\n            if (scriptNode && options?.removeOnUnmount) {\n                scriptNode.remove();\n                cachedScriptStatuses.delete(src);\n            }\n        };\n    }, [src, options?.shouldPreventLoad, options?.removeOnUnmount, options?.id]);\n    return status;\n}"
  }
}