{
  "$schema": "https://raw.githubusercontent.com/sseuniverse/sse-hooks/refs/heads/main/schema/meta.json",
  "name": "use-script",
  "type": "registry:hook",
  "title": "useScript",
  "description": "Script loading status.",
  "dependencies": [
    "react"
  ],
  "registryDependencies": [],
  "file": {
    "content": "import { useEffect, useState } from \"react\";\n\ntype UseScriptStatus = \"idle\" | \"loading\" | \"ready\" | \"error\";\n\ntype UseScriptOptions = {\n  shouldPreventLoad?: boolean;\n\n  removeOnUnmount?: boolean;\n\n  id?: string;\n};\n\nconst cachedScriptStatuses = new Map<string, UseScriptStatus | undefined>();\n\nfunction getScriptNode(src: string) {\n  const node: HTMLScriptElement | null = document.querySelector(\n    `script[src=\"${src}\"]`,\n  );\n  const status = node?.getAttribute(\"data-status\") as\n    | UseScriptStatus\n    | undefined;\n\n  return {\n    node,\n    status,\n  };\n}\n\nexport function useScript(\n  src: string | null,\n  options?: UseScriptOptions,\n): UseScriptStatus {\n  const [status, setStatus] = useState<UseScriptStatus>(() => {\n    if (!src || options?.shouldPreventLoad) {\n      return \"idle\";\n    }\n\n    if (typeof window === \"undefined\") {\n      return \"loading\";\n    }\n\n    return cachedScriptStatuses.get(src) ?? \"loading\";\n  });\n\n  useEffect(() => {\n    if (!src || options?.shouldPreventLoad) {\n      return;\n    }\n\n    const cachedScriptStatus = cachedScriptStatuses.get(src);\n    if (cachedScriptStatus === \"ready\" || cachedScriptStatus === \"error\") {\n      setStatus(cachedScriptStatus);\n      return;\n    }\n\n    const script = getScriptNode(src);\n    let scriptNode = script.node;\n\n    if (!scriptNode) {\n      scriptNode = document.createElement(\"script\");\n      scriptNode.src = src;\n      scriptNode.async = true;\n      if (options?.id) {\n        scriptNode.id = options.id;\n      }\n      scriptNode.setAttribute(\"data-status\", \"loading\");\n      document.body.appendChild(scriptNode);\n\n      const setAttributeFromEvent = (event: Event) => {\n        const scriptStatus: UseScriptStatus =\n          event.type === \"load\" ? \"ready\" : \"error\";\n\n        scriptNode?.setAttribute(\"data-status\", scriptStatus);\n      };\n\n      scriptNode.addEventListener(\"load\", setAttributeFromEvent);\n      scriptNode.addEventListener(\"error\", setAttributeFromEvent);\n    } else {\n      setStatus(script.status ?? cachedScriptStatus ?? \"loading\");\n    }\n\n    const setStateFromEvent = (event: Event) => {\n      const newStatus = event.type === \"load\" ? \"ready\" : \"error\";\n      setStatus(newStatus);\n      cachedScriptStatuses.set(src, newStatus);\n    };\n\n    scriptNode.addEventListener(\"load\", setStateFromEvent);\n    scriptNode.addEventListener(\"error\", setStateFromEvent);\n\n    return () => {\n      if (scriptNode) {\n        scriptNode.removeEventListener(\"load\", setStateFromEvent);\n        scriptNode.removeEventListener(\"error\", setStateFromEvent);\n      }\n\n      if (scriptNode && options?.removeOnUnmount) {\n        scriptNode.remove();\n        cachedScriptStatuses.delete(src);\n      }\n    };\n  }, [src, options?.shouldPreventLoad, options?.removeOnUnmount, options?.id]);\n\n  return status;\n}\n",
    "js": "import { useEffect, useState } from \"react\";\nconst cachedScriptStatuses = new Map();\nfunction getScriptNode(src) {\n    const node = document.querySelector(`script[src=\"${src}\"]`);\n    const status = node?.getAttribute(\"data-status\");\n    return {\n        node,\n        status,\n    };\n}\nexport function useScript(src, options) {\n    const [status, setStatus] = useState(() => {\n        if (!src || options?.shouldPreventLoad) {\n            return \"idle\";\n        }\n        if (typeof window === \"undefined\") {\n            return \"loading\";\n        }\n        return cachedScriptStatuses.get(src) ?? \"loading\";\n    });\n    useEffect(() => {\n        if (!src || options?.shouldPreventLoad) {\n            return;\n        }\n        const cachedScriptStatus = cachedScriptStatuses.get(src);\n        if (cachedScriptStatus === \"ready\" || cachedScriptStatus === \"error\") {\n            setStatus(cachedScriptStatus);\n            return;\n        }\n        const script = getScriptNode(src);\n        let scriptNode = script.node;\n        if (!scriptNode) {\n            scriptNode = document.createElement(\"script\");\n            scriptNode.src = src;\n            scriptNode.async = true;\n            if (options?.id) {\n                scriptNode.id = options.id;\n            }\n            scriptNode.setAttribute(\"data-status\", \"loading\");\n            document.body.appendChild(scriptNode);\n            const setAttributeFromEvent = (event) => {\n                const scriptStatus = event.type === \"load\" ? \"ready\" : \"error\";\n                scriptNode?.setAttribute(\"data-status\", scriptStatus);\n            };\n            scriptNode.addEventListener(\"load\", setAttributeFromEvent);\n            scriptNode.addEventListener(\"error\", setAttributeFromEvent);\n        }\n        else {\n            setStatus(script.status ?? cachedScriptStatus ?? \"loading\");\n        }\n        const setStateFromEvent = (event) => {\n            const newStatus = event.type === \"load\" ? \"ready\" : \"error\";\n            setStatus(newStatus);\n            cachedScriptStatuses.set(src, newStatus);\n        };\n        scriptNode.addEventListener(\"load\", setStateFromEvent);\n        scriptNode.addEventListener(\"error\", setStateFromEvent);\n        return () => {\n            if (scriptNode) {\n                scriptNode.removeEventListener(\"load\", setStateFromEvent);\n                scriptNode.removeEventListener(\"error\", setStateFromEvent);\n            }\n            if (scriptNode && options?.removeOnUnmount) {\n                scriptNode.remove();\n                cachedScriptStatuses.delete(src);\n            }\n        };\n    }, [src, options?.shouldPreventLoad, options?.removeOnUnmount, options?.id]);\n    return status;\n}"
  }
}